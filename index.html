<!doctype html>
<!--
    Tangram: real-time WebGL rendering for OpenStreetMap

    http://github.com/tangrams/tangram
    http://mapzen.com
-->
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Tangram Play</title>

    <!-- Tangram -->
    <link rel="stylesheet" href="src/js/vendor/leaflet/leaflet.css" />
    <script type="text/javascript" src="src/js/vendor/leaflet/leaflet.js"></script>  <!-- 3rd party libraries -->
    <script type="text/javascript" src="src/js/vendor/leaflet-hash.js"></script>     <!-- bog-standard leaflet URL hash -->
    <script type="text/javascript" src="https://mapzen.com/tangram/0.1/tangram.min.js"></script>

    <!-- Divider UI -->
    <script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/1.17.0/TweenLite.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/1.17.0/utils/Draggable.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/1.17.0/plugins/CSSPlugin.min.js"></script>

    <!-- Save File locally -->
    <script type="text/javascript" src="src/js/vendor/FileSaver.min.js"></script>

    <!-- Color Picker -->
    <script src='http://nornagon.github.com/thistle/thistle.js'></script>

    <!-- CodeMirror-Tangram specific -->
    <link type="text/css" rel="stylesheet" href="build/css/main.css">

  </head>

  <body>
    <div id="mobile-message" class="mobile-message">
        <div id="dismiss-mobile-message" class="mobile-message-close">&#215;</div>
        <strong>Hey there!</strong> We think youâ€™re on a mobile device, but the Tangram Play editor is best suited for desktop devices. You can close this message to continue or come back later from a desktop browser. <strong>Thanks for visiting!</strong>
    </div>
    <div id="wrapper">
        <div id="menu-container">
            <div class="menu-bar">
                <h1>Tangram Play</h1>
                <ul id="menu-holder" class="menu-items">
                    <li class="menu-item" id="menu-button-new" data-title="New style"><i class="btm bt-file"></i></li>
                    <li class="menu-item" id="menu-button-open" data-title="Open file"><i class="btm bt-plus-square"></i></li>
                    <li class="menu-item" id="menu-button-export" data-title="Export style"><i class="btm bt-download"></i></li>
                    <li class="menu-item menu-item-private" data-title="Share"><i class="btm bt-share"></i></li>
                </ul>
                <ul id="menu-holder" class="menu-items menu-right">
                    <li class="menu-item menu-item-private" data-title="Refresh map"><i class="btm bt-sync"></i></li>
                    <li class="menu-item menu-item-private" data-title="Settings"><i class="btm bt-gear"></i></li>
                    <li class="menu-item" data-title="Documentation and help"><a href="https://github.com/tangrams/tangram-docs#tangram-documentation" target="_blank"><i class="btm bt-question-circle"></i></a></li>
                    <li class="menu-item menu-item-private menu-sign-in" data-title="Sign in"><span class="menu-sign-in-label">Sign in</span><i class="btm bt-sign-in"></i></li>
                </ul>
            </div>
            <div class="menu-dropdowns">
                <div class="menu-dropdown menu-dropdown-open" id="menu-open">
                    <ul>
                        <li id="menu-open-file"><i class="btm bt-folder"></i> Open a file</li>
                        <li id="menu-open-example"><i class="btm bt-map"></i> Choose example</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="map"></div>
        <div id="divider"><span class="divider-affordance"></span></div>
        <div id="content">
            <div id="editor"></div>
        </div>

        <div id="shield" class="shield"></div>
        <div id="confirm-unsaved" class="modal">
            <p class="modal-text">Your style has not been saved. Continue?</p>

            <div class="modal-buttons">
                <button id="modal-cancel"><i class="btm bt-times"></i> Cancel</button>
                <button id="modal-confirm"><i class="btm bt-check"></i> Continue</button>
            </div>
        </div>

        <div id="choose-example" class="modal example-modal">
            <p class="modal-text">Choose example to open</p>

            <div class="examples-container">
                <div id="examples"></div>
            </div>

            <div class="modal-buttons">
                <button id="example-cancel"><i class="btm bt-times"></i> Cancel</button>
                <button id="example-confirm" disabled><i class="btm bt-check"></i> Open</button>
            </div>
        </div>

        <div id="file-drop" class="file-drop-container">
            <div class="file-drop-indicator">
                <div class="file-drop-icon"><i class="btm bt-upload"></i></div>
                <div class="file-drop-label">Drop a file here to open</div>
            </div>
        </div>

    </div>

    <!-- IDE -->
    <script type="text/javascript" src="build/js/tangram-play.js"></script>
    <script>

        const query = parseQuery(window.location.search.slice(1));
        const flags = parseFeatureFlags(query);

        if (flags['fullmenu'] === true) {
            document.querySelector('html').classList.add('full-menu');
        }

        var tangramPlay = TangramPlay.create("dom",{
            widgets: "/data/widgets.js",
            suggestedKeys: "data/suggestedKeys.js"
        });

        //  This need to be clean
        //  
        window.addEventListener('resize', function(){
            tangramPlay.reflowUI();
            tangramPlay.updateUI();
        });

        // Once everything is loaded
        setTimeout(function () {
            // if (query['foldLevel']) {
                // Editor.unfoldAll(editor);
                // Editor.foldByLevel(editor, parseInt(query['foldLevel']));
            // }
            if (query['lines']) {
                tangramPlay.editor.selectLines(query['lines']);
                // Editor.selectLines(editor, query['lines']);
            }

            // Widgets.create(editor);
        }, 500);

        if (isMobile() === true) {
            document.getElementById('mobile-message').style.display = 'block';
            document.getElementById('dismiss-mobile-message').addEventListener('click', function (e) {
                document.getElementById('mobile-message').style.display = 'none';
                tangramPlay.reflowUI();
            });
        }

        function parseQuery(qstr) {
            var query = {};
            var a = qstr.split('&');
            for (var i in a) {
                var b = a[i].split('=');
                query[decodeURIComponent(b[0])] = decodeURIComponent(b[1]);
            }
            return query;
        };

        function parseFeatureFlags(query) {
            var qstr = query['flags'];
            var flags = {};
            if (!qstr) return flags;
            var values = qstr.split(',');
            for (var i in values) {
                flags[values[i]] = true;
            }
            return flags;
        };

        function isMobile () {
          if (/iphone|ipod|android|blackberry|opera|mini|windows\sce|palm|smartphone|iemobile/i.test(navigator.userAgent.toLowerCase()))
            return true;
          else
            return false;
        };

    </script>

    <!-- Adding a script block to post message to the parent container (think iframed demos) -->
    <script type="text/javascript">
      window.addEventListener("hashchange",function(){parent.postMessage(window.location.hash, "*")});
    </script>
  </body>

</html>
